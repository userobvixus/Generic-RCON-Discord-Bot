<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCON Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #121417; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e2126; border: 1px solid #2f333a; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); border-color: #5865F2; }
        h1, h3, h5, h6 { color: #ececec; }
        label { color: #aeb0b7; font-weight: 500; font-size: 0.85em; }
        .badge-game { background-color: #5865F2; color: white; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-online { background-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .dot-offline { background-color: #e74c3c; }
        .stat-box { background: rgba(0,0,0,0.2); border-radius: 5px; padding: 10px; font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container mt-5 mb-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üöÄ RCON Center</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServerModal">
                <i class="fas fa-plus"></i> Ajouter un Serveur
            </button>
        </div>
        
        <div class="row" id="server-list">
            <% if(servers.length === 0) { %>
                <div class="col-12"><div class="alert alert-warning border-0 bg-opacity-10">‚ö†Ô∏è Aucun serveur configur√©. Cliquez sur "Ajouter" en haut √† droite.</div></div>
            <% } %>

            <% servers.forEach(function(server) { 
                const state = (serverStates && serverStates[server.id]) ? serverStates[server.id] : { isOnline: false, players: '---', map: '---' };
            %>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-transparent border-secondary d-flex justify-content-between align-items-center">
                            <div>
                                <span class="status-dot <%= state.isOnline ? 'dot-online' : 'dot-offline' %>"></span>
                                <span class="fw-bold"><%= server.nom %></span>
                            </div>
                            <span class="badge badge-game"><%= server.gameType %></span>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-3 text-center">
                                <div class="col-6">
                                    <div class="stat-box">
                                        <i class="fas fa-users text-info mb-1"></i><br>
                                        <strong><%= state.players %></strong>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-box">
                                        <i class="fas fa-map text-warning mb-1"></i><br>
                                        <span class="text-truncate d-block" style="max-width: 100%;"><%= state.map %></span>
                                    </div>
                                </div>
                            </div>

                            <div class="small text-muted mb-3">
                                <div class="d-flex justify-content-between"><span>IP:</span> <span class="font-monospace text-white"><%= server.ip %></span></div>
                                <div class="d-flex justify-content-between"><span>Query:</span> <span class="font-monospace text-white"><%= server.queryPort %></span></div>
                                <div class="d-flex justify-content-between"><span>Salon:</span> <span class="font-monospace text-white"><%= server.discordChannelId %></span></div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-warning btn-sm flex-fill btn-edit" 
                                    data-server='<%- JSON.stringify(server) %>'
                                    data-bs-toggle="modal" data-bs-target="#editServerModal">
                                    <i class="fas fa-edit"></i> Modifier
                                </button>
                                
                                <form action="/delete-server" method="POST" class="flex-fill" onsubmit="return confirm('√ätes-vous s√ªr ?');">
                                    <input type="hidden" name="id" value="<%= server.id %>">
                                    <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>

    <div class="modal fade" id="addServerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: #1e2126; color: white;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">‚ûï Ajouter un serveur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="/add-server" method="POST">
                        <%- include('form-fields') %>
                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-primary">Ajouter</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editServerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: #1e2126; color: white;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">‚úèÔ∏è Modifier le serveur</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form action="/edit-server" method="POST" id="editForm">
                        <input type="hidden" name="id" id="edit_id">
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label>Nom</label>
                                <input type="text" name="nom" id="edit_nom" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label>Jeu</label>
                                <select name="gameType" id="edit_gameType" class="form-select">
                                    <optgroup label="Les Classiques">
                                        <option value="rust">Rust</option>
                                        <option value="minecraft">Minecraft</option>
                                        <option value="arkse">ARK: Survival Evolved</option>
                                        <option value="asa">ARK: Survival Ascended</option>
                                    </optgroup>
                                    <optgroup label="Survie & Gestion">
                                        <option value="palworld">Palworld</option>
                                        <option value="pz">Project Zomboid</option>
                                        <option value="vrising">V Rising</option>
                                        <option value="conan">Conan Exiles</option>
                                        <option value="factorio">Factorio</option>
                                        <option value="7d2d">7 Days to Die</option>
                                        <option value="avorion">Avorion</option>
                                    </optgroup>
                                    <optgroup label="FPS / Source Engine">
                                        <option value="cs2">Counter-Strike 2 / CS:GO</option>
                                        <option value="gmod">Garry's Mod</option>
                                        <option value="tf2">Team Fortress 2</option>
                                        <option value="l4d2">Left 4 Dead 2</option>
                                    </optgroup>
                                    <optgroup label="Autre">
                                        <option value="other">Autre (Generic Valve)</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-4"><label>IP</label><input type="text" name="ip" id="edit_ip" class="form-control font-monospace" required></div>
                            <div class="col-md-4"><label>Port RCON</label><input type="number" name="port" id="edit_port" class="form-control font-monospace" required></div>
                            <div class="col-md-4"><label>Port Query</label><input type="number" name="queryPort" id="edit_queryPort" class="form-control font-monospace" required></div>
                            <div class="col-md-12"><label>Mot de passe RCON</label><input type="text" name="password" id="edit_password" class="form-control"></div>
                            
                            <div class="col-md-4"><label>Salon Commandes</label><input type="text" name="discordChannelId" id="edit_discordChannelId" class="form-control" required></div>
                            <div class="col-md-4"><label>R√¥le Admin</label><input type="text" name="adminRoleId" id="edit_adminRoleId" class="form-control"></div>
                            <div class="col-md-4"><label>Salon Status</label><input type="text" name="statusChannelId" id="edit_statusChannelId" class="form-control"></div>
                            <input type="hidden" name="logChannelId" id="edit_logChannelId">
                        </div>

                        <div class="text-end mt-3">
                            <button type="submit" class="btn btn-warning">Sauvegarder</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        document.querySelectorAll('.btn-edit').forEach(button => {
            button.addEventListener('click', function() {
                const data = JSON.parse(this.getAttribute('data-server'));
                document.getElementById('edit_id').value = data.id;
                document.getElementById('edit_nom').value = data.nom;
                document.getElementById('edit_gameType').value = data.gameType;
                document.getElementById('edit_ip').value = data.ip;
                document.getElementById('edit_port').value = data.port;
                document.getElementById('edit_queryPort').value = data.queryPort;
                document.getElementById('edit_password').value = data.password;
                document.getElementById('edit_discordChannelId').value = data.discordChannelId;
                document.getElementById('edit_adminRoleId').value = data.adminRoleId || '';
                document.getElementById('edit_statusChannelId').value = data.statusChannelId || '';
                document.getElementById('edit_logChannelId').value = data.logChannelId || '';
            });
        });
    </script>
</body>
</html>